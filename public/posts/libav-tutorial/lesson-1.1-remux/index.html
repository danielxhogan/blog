<!DOCTYPE html>
<html lang="en-us"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">Lesson 1.1: Remux | danielxhogan</title>
<meta property="og:title" content="Lesson 1.1: Remux | danielxhogan" />
<meta name="twitter:title" content="Lesson 1.1: Remux | danielxhogan" />
<meta itemprop="name" content="Lesson 1.1: Remux | danielxhogan" />
<meta name="application-name" content="Lesson 1.1: Remux | danielxhogan" />
<meta property="og:site_name" content="" />

<meta name="description" content="">
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />

<meta property="og:locale" content="en-us" />
<meta name="language" content="en-us" />

  <link rel="alternate" hreflang="en" href="http://localhost:1313/posts/libav-tutorial/lesson-1.1-remux/" title="" />





    
    
    

    <meta property="og:type" content="article" />
    <meta property="og:article:published_time" content=2025-04-12T12:23:33-0700 />
    <meta property="article:published_time" content=2025-04-12T12:23:33-0700 />
    <meta property="og:url" content="http://localhost:1313/posts/libav-tutorial/lesson-1.1-remux/" />

    
    <meta property="og:article:author" content="" />
    <meta property="article:author" content="" />
    <meta name="author" content="" />
    
    

    

    <script defer type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "Lesson 1.1: Remux",
        "author": {
        "@type": "Person",
        "name": ""
        },
        "datePublished": "2025-04-12",
        "description": "",
        "wordCount":  1623 ,
        "mainEntityOfPage": "True",
        "dateModified": "2025-04-12",
        "image": {
        "@type": "imageObject",
        "url": ""
        },
        "publisher": {
        "@type": "Organization",
        "name": "danielxhogan"
        }
    }
    </script>


<meta name="generator" content="Hugo 0.123.7">

    
    <meta property="og:title" content="Lesson 1.1: Remux" />
<meta property="og:description" content="In this lesson, you will learn how to use Libav to remux a video file. You will learn about the AVFormatContext struct that is used for muxing and demuxing, you will learn how to open an output file and prepare it for storing video and audio streams, and you will learn how to read packets of data from an input and write them to an output. All the code for this tutorial can found here." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/libav-tutorial/lesson-1.1-remux/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-04-12T12:23:33-07:00" />
<meta property="article:modified_time" content="2025-04-12T12:23:33-07:00" />



    
    <meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Lesson 1.1: Remux"/>
<meta name="twitter:description" content="In this lesson, you will learn how to use Libav to remux a video file. You will learn about the AVFormatContext struct that is used for muxing and demuxing, you will learn how to open an output file and prepare it for storing video and audio streams, and you will learn how to read packets of data from an input and write them to an output. All the code for this tutorial can found here."/>


    

    <link rel="canonical" href="http://localhost:1313/posts/libav-tutorial/lesson-1.1-remux/">
    <link href="/style.min.e390ba7da26222f4dc42a349955d76dbbe44e5ce2535a43de5a70633a0a9ec3c.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    
    
</head>
<body data-theme = "" class="notransition">

<script src="/js/theme.js"></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title></title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/tutorials/">
                        Tutorials
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/about_me/">
                        About Me
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">Lesson 1.1: Remux</h1>
                
                
                
                <div class="post-meta">
                    <time datetime="2025-04-12T12:23:33-07:00" itemprop="datePublished"> Apr 12, 2025 </time>
                </div>
                
            </header>
            
            <div class="page-content">
                <p><img src="/images/LibavTutorial/Lesson_1.1/nope.jpg" alt="nope"></p>
<p>In this lesson, you will learn how to use Libav to remux a video file. You will
learn about the <code>AVFormatContext</code> struct that is used for muxing and demuxing,
you will learn how to open an output file and prepare it for storing video and
audio streams, and you will learn how to read packets of data from an input
and write them to an output. All the code for this tutorial can found
<a href="https://github.com/danielxhogan/LibavTutorial/tree/main/Lesson%201%3A%20Remux/Lesson%201.1%3A%20Remux">here</a>.</p>
<p>To follow along with this tutorial, you&rsquo;ll need to have the following packages
installed:</p>
<ul>
<li>gcc</li>
<li>ninja</li>
<li>meson</li>
<li>libavformat-dev</li>
<li>libavcodec-dev</li>
<li>libavutil-dev</li>
</ul>
<p>The first thing you&rsquo;ll need to do is copy the meson.build file and create a
blank remux.c file. To generate a build configuration, open a terminal, <code>cd</code>
into the Remux directory, and run the command <code>meson setup build</code>. From this
point on, all you need to do to compile the code is <code>cd</code> into the build
directory and run <code>ninja</code>. The commands to run the program can be found in the
<code>run.sh</code> file. There are several video files provided in the <code>videos/inputs</code>
folder and the commands are designed to store the ouput files in
<code>videos/outputs</code> so you&rsquo;ll need to create that folder.</p>
<h2 id="opening-input-file--initializing-avformatcontexts">Opening Input File &amp; Initializing AVFormatContext&rsquo;s</h2>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>AVFormatContext <span style="color:#81a1c1">*</span>in_fmt_ctx <span style="color:#81a1c1">=</span> <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">,</span> <span style="color:#81a1c1">*</span>out_fmt_ctx <span style="color:#81a1c1">=</span> <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">((</span>ret <span style="color:#81a1c1">=</span> <span style="color:#88c0d0">avformat_open_input</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>in_fmt_ctx<span style="color:#eceff4">,</span> in_filename<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">,</span> <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">))</span> <span style="color:#81a1c1">&lt;</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#88c0d0">fprintf</span><span style="color:#eceff4">(</span>stderr<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;Failed to open input video file: &#39;%s&#39;.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>    in_filename<span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1;font-weight:bold">goto</span> end<span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">((</span>ret <span style="color:#81a1c1">=</span> <span style="color:#88c0d0">avformat_find_stream_info</span><span style="color:#eceff4">(</span>in_fmt_ctx<span style="color:#eceff4">,</span> <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">))</span> <span style="color:#81a1c1">&lt;</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#88c0d0">fprintf</span><span style="color:#eceff4">(</span>stderr<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;Failed to retrieve input stream info.&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1;font-weight:bold">goto</span> end<span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#88c0d0">av_dump_format</span><span style="color:#eceff4">(</span>in_fmt_ctx<span style="color:#eceff4">,</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">,</span> in_filename<span style="color:#eceff4">,</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">((</span>ret <span style="color:#81a1c1">=</span> <span style="color:#88c0d0">avformat_alloc_output_context2</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>out_fmt_ctx<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">,</span> <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">,</span> out_filename<span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#88c0d0">fprintf</span><span style="color:#eceff4">(</span>stderr<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;Failed to allocate output format context.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1;font-weight:bold">goto</span> end<span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8fbcbb">end</span><span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#88c0d0">avformat_close_input</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>in_fmt_ctx<span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#88c0d0">avformat_free_context</span><span style="color:#eceff4">(</span>out_fmt_ctx<span style="color:#eceff4">);</span></span></span></code></pre></div>
<p>Once we&rsquo;ve added our <code>#include</code> statements, declared all the necessary
variables, and defined the usage print statement, the first thing we&rsquo;ll do is
open the input file that is passed on the command line. The
<code>AVFormatContext</code> struct is the main struct used in Libav to represent a
file. There are two main ways for allocating an <code>AVFormatContext</code> struct,
depending on whether the file is an existing file being read from disk or
whether we are creating the file. If we are opening an existing file, we
use <code>avformat_open_input</code> and if we are creating the file, we use
<code>avformat_alloc_output_context2</code>. The former is usually paired with the
<code>avformat_find_stream_info</code> function. For this example, this function is mostly
needed if the input file is a webm or flv file. We can also call the
<code>av_dump_format</code> function which will print out information about the input file,
much like when running <code>ffprobe</code> on the file. The latter creates a blank struct
that will be manually populated.</p>
<p>Both functions have the option to take in a format
struct, either <code>AVFormatInput</code> or <code>AVFormatOutput</code>, that will determine
the format of the file. When opening a file, if the file does not match the
specified format, this will cause an error. If a format is not provided, it
will be auto detected. When creating a file, if a format is not specified,
the name of the output file provided will be used to determine the outuput
format, just like when using <code>ffmpeg</code>.</p>
<h2 id="adding-streams">Adding Streams</h2>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">((</span>ret <span style="color:#81a1c1">=</span> v_stream_idx <span style="color:#81a1c1">=</span> <span style="color:#88c0d0">av_find_best_stream</span><span style="color:#eceff4">(</span>in_fmt_ctx<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>  AVMEDIA_TYPE_VIDEO<span style="color:#eceff4">,</span> <span style="color:#81a1c1">-</span><span style="color:#b48ead">1</span><span style="color:#eceff4">,</span> <span style="color:#81a1c1">-</span><span style="color:#b48ead">1</span><span style="color:#eceff4">,</span> <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">,</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">))</span> <span style="color:#81a1c1">&lt;</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#88c0d0">fprintf</span><span style="color:#eceff4">(</span>stderr<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;Failed to find video stream in input file.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1;font-weight:bold">goto</span> end<span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1">!</span><span style="color:#eceff4">(</span>out_stream <span style="color:#81a1c1">=</span> <span style="color:#88c0d0">avformat_new_stream</span><span style="color:#eceff4">(</span>out_fmt_ctx<span style="color:#eceff4">,</span> <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">)))</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#88c0d0">fprintf</span><span style="color:#eceff4">(</span>stderr<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;Failed to allocate video output stream.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>  ret <span style="color:#81a1c1">=</span> <span style="color:#88c0d0">AVERROR</span><span style="color:#eceff4">(</span>ENOMEM<span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1;font-weight:bold">goto</span> end<span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">((</span>ret <span style="color:#81a1c1">=</span> <span style="color:#88c0d0">avcodec_parameters_copy</span><span style="color:#eceff4">(</span>out_stream<span style="color:#81a1c1">-&gt;</span>codecpar<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>  in_fmt_ctx<span style="color:#81a1c1">-&gt;</span>streams<span style="color:#eceff4">[</span>v_stream_idx<span style="color:#eceff4">]</span><span style="color:#81a1c1">-&gt;</span>codecpar<span style="color:#eceff4">))</span> <span style="color:#81a1c1">&lt;</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#88c0d0">fprintf</span><span style="color:#eceff4">(</span>stderr<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;failed to copy video codec parameters</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1;font-weight:bold">goto</span> end<span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>out_stream<span style="color:#81a1c1">-&gt;</span>codecpar<span style="color:#81a1c1">-&gt;</span>codec_tag <span style="color:#81a1c1">=</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">;</span></span></span></code></pre></div>
<p>Now that we&rsquo;ve created a blank <code>AVFormatContext</code> struct for our output file, we
need to start populating it. The first thing we&rsquo;ll do is create an <code>AVStream</code>
for the video stream. To do this, we&rsquo;ll use the <code>avformat_new_stream</code> function,
and pass in <code>out_fmt_ctx</code>. The <code>AVFormatContext</code> struct contains a <code>streams</code>
array which contains all the streams for the file. The <code>avformat_new_stream</code>
function will allocate a new <code>AVStream</code>, add it to the streams array of
<code>out_fmt_ctx</code>, and return a pointer to it, or <code>NULL</code> on error.</p>
<p>Once we have a new blank stream for the video, we&rsquo;ll need to populate it
with all the information about the stream we want to create. In this case, we
are copying the stream from the input so we&rsquo;ll copy all the same information.
To do this, we&rsquo;ll need to know which stream in the input is the video stream.
We&rsquo;ll use the <code>av_find_best_stream</code> function to get the index of the <code>streams</code>
array from <code>in_fmt_ctx</code> that holds the video stream. We&rsquo;ll pass in
<code>AVMEDIA_TYPE_VIDEO</code> so the function will look for a video stream. It will
generally return the first video stream it finds, as long as there is a decoder
for that stream&rsquo;s codec. This is similar to using <code>ffmpeg</code> without using the
<code>map</code> option.</p>
<p>Once we know the index of the video stream, we&rsquo;ll use the
<code>avcodec_copy_parameters</code> function to copy the <code>codecpar</code> struct from the video
stream in <code>in_fmt_ctx</code> to the new <code>AVStream</code> we just created. Although we are
not decoding any data in this example, the output file will need to contain all
this information so that it can be decoded properly for playback or further
processing. The last thing we&rsquo;ll do is make sure that <code>codec_tag</code> is set to
<code>0</code>. This is to make sure it is set properly later on. This value should be set
by <code>avformat_write_header</code>, which will be called later, but the value will only
by overwritten if it is initially set to <code>0</code>.</p>
<p>The process for creating the audio stream is mostly the same as for the video
except we&rsquo;ll specify <code>AVMEDIA_TYPE_AUDIO</code> as the stream type to look for in the
input file.</p>
<h2 id="pre-muxing">Pre Muxing</h2>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1">!</span><span style="color:#eceff4">(</span>pkt <span style="color:#81a1c1">=</span> <span style="color:#88c0d0">av_packet_alloc</span><span style="color:#eceff4">()))</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#88c0d0">fprintf</span><span style="color:#eceff4">(</span>stderr<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;Failed to allocate AVPacket.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>    ret <span style="color:#81a1c1">=</span> <span style="color:#88c0d0">AVERROR</span><span style="color:#eceff4">(</span>ENOMEM<span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1;font-weight:bold">goto</span> end<span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1">!</span><span style="color:#eceff4">(</span>out_fmt_ctx<span style="color:#81a1c1">-&gt;</span>oformat<span style="color:#81a1c1">-&gt;</span>flags <span style="color:#81a1c1">&amp;</span> AVFMT_NOFILE<span style="color:#eceff4">))</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">((</span>ret <span style="color:#81a1c1">=</span> <span style="color:#88c0d0">avio_open</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>out_fmt_ctx<span style="color:#81a1c1">-&gt;</span>pb<span style="color:#eceff4">,</span> out_filename<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>      AVIO_FLAG_WRITE<span style="color:#eceff4">))</span> <span style="color:#81a1c1">&lt;</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#88c0d0">fprintf</span><span style="color:#eceff4">(</span>stderr<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;Failed to open output file.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#81a1c1;font-weight:bold">goto</span> end<span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">((</span>ret <span style="color:#81a1c1">=</span> <span style="color:#88c0d0">avformat_write_header</span><span style="color:#eceff4">(</span>out_fmt_ctx<span style="color:#eceff4">,</span> <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">))</span> <span style="color:#81a1c1">&lt;</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#88c0d0">fprintf</span><span style="color:#eceff4">(</span>stderr<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;Failed to write header for output file.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1;font-weight:bold">goto</span> end<span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8fbcbb">end</span><span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#88c0d0">av_packet_free</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>pkt<span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">(</span>out_fmt_ctx <span style="color:#81a1c1">&amp;&amp;</span> <span style="color:#81a1c1">!</span><span style="color:#eceff4">(</span>out_fmt_ctx<span style="color:#81a1c1">-&gt;</span>flags <span style="color:#81a1c1">&amp;</span> AVFMT_NOFILE<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#88c0d0">avio_closep</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>out_fmt_ctx<span style="color:#81a1c1">-&gt;</span>pb<span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">...</span></span></span></code></pre></div>
<p>Now that we&rsquo;ve prepared the output context, we have a few things to do before
we&rsquo;ll start muxing. The first thing we&rsquo;ll do is allocate an <code>AVPacket</code> that
will be used to store data read from the input file. The next thing we&rsquo;ll do is
create an output file that the data will be read to. Some demuxers will create
the file automatically so we first need to check if there is an <code>AVFMT_NOFILE</code>
flag on output format. If not, we call <code>avio_open</code> which will create a file
with the name passed in on the command line, open it for writing, and store a
reference to it in the <code>pb</code> field of <code>out_fmt_ctx</code>. Lastly, well call
<code>avformat_write_header</code>. This will write all the necessary metadata to the
file such as the container format, number of streams, and codecs used,
as well as any other information that will be needed to properly open and read
the contents of the file. We will also need to add lines to the <code>end</code> procedure
to free the <code>AVPacket</code> and close the file.</p>
<h2 id="muxing">Muxing</h2>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#81a1c1;font-weight:bold">while</span> <span style="color:#eceff4">((</span>ret <span style="color:#81a1c1">=</span> <span style="color:#88c0d0">av_read_frame</span><span style="color:#eceff4">(</span>in_fmt_ctx<span style="color:#eceff4">,</span> pkt<span style="color:#eceff4">))</span> <span style="color:#81a1c1">&gt;=</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>    in_stream <span style="color:#81a1c1">=</span> in_fmt_ctx<span style="color:#81a1c1">-&gt;</span>streams<span style="color:#eceff4">[</span>pkt<span style="color:#81a1c1">-&gt;</span>stream_index<span style="color:#eceff4">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">(</span>pkt<span style="color:#81a1c1">-&gt;</span>stream_index <span style="color:#81a1c1">==</span> v_stream_idx<span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>      pkt<span style="color:#81a1c1">-&gt;</span>stream_index <span style="color:#81a1c1">=</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1;font-weight:bold">else</span> <span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">(</span>pkt<span style="color:#81a1c1">-&gt;</span>stream_index <span style="color:#81a1c1">==</span> a_stream_idx<span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>      pkt<span style="color:#81a1c1">-&gt;</span>stream_index <span style="color:#81a1c1">=</span> <span style="color:#b48ead">1</span><span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1;font-weight:bold">else</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#88c0d0">av_packet_unref</span><span style="color:#eceff4">(</span>pkt<span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#81a1c1;font-weight:bold">continue</span><span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pkt<span style="color:#81a1c1">-&gt;</span>pos <span style="color:#81a1c1">=</span> <span style="color:#81a1c1">-</span><span style="color:#b48ead">1</span><span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>    out_stream <span style="color:#81a1c1">=</span> out_fmt_ctx<span style="color:#81a1c1">-&gt;</span>streams<span style="color:#eceff4">[</span>pkt<span style="color:#81a1c1">-&gt;</span>stream_index<span style="color:#eceff4">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#88c0d0">av_packet_rescale_ts</span><span style="color:#eceff4">(</span>pkt<span style="color:#eceff4">,</span> in_stream<span style="color:#81a1c1">-&gt;</span>time_base<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>      out_stream<span style="color:#81a1c1">-&gt;</span>time_base<span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">((</span>ret <span style="color:#81a1c1">=</span> <span style="color:#88c0d0">av_interleaved_write_frame</span><span style="color:#eceff4">(</span>out_fmt_ctx<span style="color:#eceff4">,</span> pkt<span style="color:#eceff4">))</span> <span style="color:#81a1c1">&lt;</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#88c0d0">fprintf</span><span style="color:#eceff4">(</span>stderr<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;Failed to write packet to file.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#81a1c1;font-weight:bold">goto</span> end<span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#88c0d0">av_packet_unref</span><span style="color:#eceff4">(</span>pkt<span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">((</span>ret <span style="color:#81a1c1">=</span> <span style="color:#88c0d0">av_write_trailer</span><span style="color:#eceff4">(</span>out_fmt_ctx<span style="color:#eceff4">))</span> <span style="color:#81a1c1">&lt;</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#88c0d0">fprintf</span><span style="color:#eceff4">(</span>stderr<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;Failed to write trailer to file.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#81a1c1;font-weight:bold">goto</span> end<span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">}</span></span></span></code></pre></div>
<p>We&rsquo;ll start by calling <code>av_read_frame</code> inside an loop that runs as long the
return value is not negative. A negative value signals the end of the file,
or an error. The packet data read from the input will be stored in <code>pkt</code>. This
struct will have a field <code>stream_index</code> specifying which stream from the input
it came from. This value is used to get a reference to that stream from
<code>in_fmt_ctx-&gt;streams</code>. We check if the the packet came from the video stream or
the audio stream, and then overwrite the value of the packet&rsquo;s <code>stream_index</code>
because this value will be used by the muxer to determine which stream to place
the packet into in the output file. If the packet does not belong the either the
video or audio stream that was found earlier when we called
<code>av_find_best_stream</code>, it is ignored.</p>
<p>Next we&rsquo;ll set <code>pkt-&gt;pos</code> to -1 so that it will be set by the muxer. Initially
this value will indicate the position of the packet in the input file but it
needs to be reset to the position of the packet in the output file. After that,
we&rsquo;ll call <code>av_packet_rescale_ts</code>. This will make sure that if the output file
has a different time base for it&rsquo;s timestamps, the timestamp of each packet
will be converted.</p>
<p>Finally, we will call <code>av_interleaved_write_frame</code> to write the packet to the
output file. Once the loop has finished, all data from the input should now
be written to the new output file. The only thing left to do is call
<code>av_write_trailer</code> which will write any necessary metadata to file that wasn&rsquo;t
known before the writing process such as byte locations of I frames used for
seeking.</p>
<p>In the next lesson, we will build off the concepts in this lesson by learning
how to access, transfer, and set user defined metadata values. You will be
able to copy all metadata from the input to the output and pass in a title
value on the command line that will be used to set the metadata title of the
output. You will also learn how to transfer chapter information.</p>

            </div>
        </article></main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://letterboxd.com/hugexjackedman/" target="_blank" rel="noopener noreferrer me"
    title="Letterboxd">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"fill="currentColor">
    <path d="M11.052 22.339V9.599H8.729V6.401h8.438v3.198h-2.328v12.766h5.234v-3.49h3.781v6.724H8.729v-3.26zM0 16c0 8.839 7.161 16 16 16s16-7.161 16-16S24.839 0 16 0S0 7.161 0 16z"/>
</svg>
</a>
</div>
    <small class="footer_copyright">
        © 2025 .
        
    </small>
</footer>







    
    <script async src="http://localhost:1313/js/main.js" ></script>

    

</body>
</html>
